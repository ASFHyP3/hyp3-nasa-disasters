# Image Services - asf_services

This directory contains the files necessary to generate mosaic datasets for use by ASF's ArcGIS Image Server in the publication of image services. 

The files have been changed as necessary to configure the mosaic datasets appropriately for serving datasets generated by ASF's HyP3 platform. 

The datasets currently published to image services include the following:

- Radiometric Terrain Corrected (RTC) products, dual band VV and VH
- RGB Decomposition products, 3-band RGB 
- Surface water extent products, single-band mask

The source rasters for the mosaic datasets are stored in an AWS S3 bucket, with a different prefix for each AOI. The contents of these buckets are updated daily. The overview CRF files are also written to the S3 bucket, under the esri prefix.

The following path can be replaced to reflect the location of this directory when the repo is downloaded:
	
	C:\Users\hjkristenson\PycharmProjects\hyp3-nasa-disasters\image_server\

All files necessary for this workflow are contained within this asf_services directory, except for those including credentials. See the [Credentials](#credentials) section for more information. 

## Workflow

There are two AOIs supported by the scripts in this directory. The Hurricanes AOI covers the East Coast of the U.S., and the HKH AOI covers the Hindu Kush Himalayan region, which prone to flooding during the monsoon season.

We plan to extend the Hurricanes AOI to cover the contiguous U.S. States, so the services themselves are branded as RTC_services in some cases. 

The update scripts use the following workflow for each of the AOIs: 
1. Create a new geodatabase tagged with today's date
2. Generate new mosaic datasets for each of the datasets, pulling all available data from the S3 bucket prefix for the AOI
3. Generate overview CRF files and add them to the mosaic datasets
4. Publish an AID package for each service for each AOI
5. Update the image services on the ArcGIS Imagery Dedicated platform with the new AID packages

This workflow could also be used to create a new service. The final portion of the script that updates the image service would just need to be adjusted to create a new service rather than update an existing one.

## Running the Scripts

The batchFiles directory contains all of the scripts that orchestrate the workflow.

- update_hurricanes.py can be run alone to update the services for the Hurricanes AOI
- update_hkh.py can be run alone to update the services for the HKH AOI
- update_services.bat runs the update_hkh.py and update_hurricanes.py scripts sequentially, and can be used to set up an automated workflow to update the services daily.

The python path will need to be changed to match the system used to run the scripts. The current python path is specified as:

	C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\python.exe

## Credentials

The scrips make use of an acs file, and also portal credentials. These credentials are not saved in this repo, and will need to be generated for use before these scripts can be run. 

The acs path will need to be replaced in the scripts with the appropriate path for a user's acs file: 

C:\Users\ASF\Documents\COVID19\Disasters\FloodAreas\NASA_Disasters_AWS.acs

The portal credentials are accessed using keyring, in the following section of code: 

	import keyring
	pw = keyring.get_password("portal_creds", "hkristenson_ASF")
	arcpy.SignInToPortal(r'https://asf-daac.maps.arcgis.com/', 'hkristenson_ASF', pw)

Users will either need to set up their own keyring credentials, or use a different approach for authenticating portal credentials. 

## Reference files

There are a number of files scattered throughout the MDCS directory structure that are accessed by the update scripts. 

The other batch files in the **batchFiles** directory are re-generated each time the update script is run, and orchestrate the MDCS process that outputs the mosaic dataset for each service.

The configuration files in the **Parameter/Config** directory define the settings for the generation of the mosaic datasets and the overviews for each service. 

The geodatabase in the **Parameter/Boundary** directory contains feature classes used for clipping the mosaic dataset to a specific boundary.

The **Parameter/RasterFunctionTemplates** directory contains the RFTs published with the services.

The **Parameter/Rastertype** includes config files used to combine the VV and VH datasets into a single two-band raster for each acquisition.

The **scripts** directory contains the python scripts called during the MDCS process. The only custom script is **MDCS_UC.py**, which adds attribute fields and sets attribute values for the mosaic datasets and overviews. 

There are outputs written to a number of directories. 

- The **AID** directory contains the AID Toolbox, but also the output AID files
- Logs are written to the **logs** directory
- The geodatabases are written to the **MD** directory
- The **PixelCache** directory contains the pixel cache
- The **scratch** directory contains a gdb used as the scratch workspace

# mdcs-py (Esri Documentation)

The Mosaic Dataset Configuration Script (MDCS) is a Python script that reads parameters stored in an xml file in order to create, configure, and populate a [mosaic dataset](http://desktop.arcgis.com/en/arcmap/10.3/manage-data/raster-and-images/what-is-a-mosaic-dataset.htm).

If you want to try out MDCS, review the documentation included in the repo for instructions, and download the suggested sample data from [ArcGIS Online](http://pm.maps.arcgis.com/home/item.html?id=5f6c9a157ffc45c4863996c2987f4ac9). 

This repo also contains [MDTools](https://github.com/Esri/mdcs-py/blob/master/Documentation/MDTools_ReadMe.pdf), a command line tool that simplifies some common management tasks when working with rasters in a mosaic dataset.

## Features

* Automate the creation of multiple mosaic datasets
* Configure multiple mosaic datasets using XML files
* Built-in verbose reporting and logging system
* Command line usage via batch files 
* Compatible with ArcMap 10.1+ and ArcGIS Pro 1.0+ (MDTools requires ArcMap 10.6.1+ or ArcGIS Pro 2.2+)
* Use MDTools to do the following: 
	- Embed raster proxies in a mosaic dataset
	- Perform search and replace for embedded raster proxy strings
	- Export file locations to a text file for rasters in a mosaic dataset in a given area of interest (AOI) and with a specific cell size

## Instructions

1. Download the ZIP file (called mdcs-py-master.zip)
2. Create a folder called Image_Mgmt_Workflows in the root of your C: drive
3. Unzip the contents of the MDCS ZIP file into the Image_Mgmt_Workflows folder

To get started with MDTools:

4. Navigate to C:/Image_Mgmt_Workflows/mdcs-py/MDTools_Setup.zip
5. Unzip the contents, then double-click MDTools_Setup.exe to install the tools.
6. Refer to the [MDTools documentation](https://github.com/Esri/mdcs-py/blob/master/Documentation/MDTools_ReadMe.pdf) to get started.

## Suggested Requirements

* Notepad / XML Editor
* Knowledge of [Mosaic Datasets](https://pro.arcgis.com/en/pro-app/help/data/imagery/mosaic-datasets.htm)
* Knowledge of Python

## Resources

* Dowload [sample data](http://pm.maps.arcgis.com/home/item.html?id=5f6c9a157ffc45c4863996c2987f4ac9) for use with MDCS.
* See the [Managing Elevation workflow scripts](http://www.arcgis.com/home/item.html?id=d2a055e12af14258a931fdc3ecf2c8b4) on ArcGIS Online for an example application of MDCS.

## Issues

Find a bug or want to request a new feature?  Please let us know by submitting an issue.

## Contributing

Anyone and everyone is welcome to contribute. 

## Licensing
Copyright 2012-2020 Esri
Modifications Copyright 2021 Alaska Satellite Facility

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

A copy of the license is available in the repository's [license.txt](https://github.com/ArcGIS/mdcs-py/blob/master/license.txt) file.



